#!/bin/bash
###############################################################################
# Script de instalación de BulmaGés
# (C) Tomeu Borrás, Septiempbre 2004
# Este documento es GPL
#------------------------------------------------------------------------------
# Parametros
#     $1 : --texto
#          --dialog (por defecto)
###############################################################################


# Primeros pinitos con archivos de Debian
#. /usr/share/debconf/confmodule
#db_version 2.0
#db_input low foo/bar || true
#db_go || true

#Buscamos el parametro para saber si es texto o no
if [ "$1" = "--texto" ]; then
  texto="1"
  ptexto="--texto"
else
  texto="0"
  ptexto="--dialog"
fi

#Borramos antiguos archivos que puedan dar problemas
if [ -e /tmp/errores1.txt ]; then
    rm /tmp/errores1.txt
fi
if [ -e /tmp/errores1.txt ]; then
rm /tmp/errores1.txt
fi
if [ -e /tmp/listdb.lst ]; then
rm /tmp/listdb.lst
fi
if [ -e /tmp/listuser.lst ]; then
rm /tmp/listuser.lst
fi
if [ -e /tmp/error.txt ]; then
rm /tmp/error.txt
fi


# Esta función presenta mensajes por pantalla
function mensaje() {
   if [ ! -e /usr/bin/dialog -o $texto = 1 ]; then
      echo -e "$2" "$1"  "$3"
   else
      dialog --title "Instalación de BulmaGés v0.4.9" --backtitle "Asociación Iglues" --msgbox "$1" 10 60
   fi
}

# Esta función presenta mensajes.
function info() {
   if [ ! -e /usr/bin/dialog -o $texto = 1 ]; then
      echo -e  "$2" "$1"  "$3"
   else
      dialog  --title "Instalación de BulmaGés v0.4.9" --backtitle "Asociación Iglues" --infobox "$1" 10 60
   fi
}

#Esta función crea usuarios que van a manejar la base de datos.
function lee() {
        if [ ! -e /usr/bin/dialog -o $texto = 1 ]; then
                echo -e  "\033[33m""Indique el usuario que va a trabajar normalmente con el programa:"  "\033[0m"
                read user
        else
                dialog --title "Instalacion de BulmaGes v0.4.9" --inputbox "Nombre del usuario que va a trabajar normalmente con BulmaGes. \n deje el campo en blanco para terminar." 10 60  2>/tmp/dialog.ans
                user=`cat /tmp/dialog.ans`
                rm -f /tmp/dialog.ans # don't litter !
        fi
        while [ "$user" != "" ]
        do
                su - postgres -c "createuser --adduser --createdb $user"
                if [ ! -e /usr/bin/dialog -o $texto = 1 ]; then
                        echo -e  "\033[33m""Indique el usuario que va a trabajar normalmente con el programa:"  "\033[0m"
                        read user
                else
                        dialog --title "Instalacion de BulmaGes v0.4.9" --inputbox "Nombre del usuario que va a trabajar normalmente con BulmaGes. \n deje el campo en blanco para terminar." 10 60  2>/tmp/dialog.ans
                        user=`cat /tmp/dialog.ans`
                        rm -f /tmp/dialog.ans # don't litter !
                fi
        done
}

function tiempo {
  sleep 1.5
}

function linea {
   if [ ! -e /usr/bin/dialog ]; then
     echo -e "\033[32m----------------------------------------------\033[0m\n"
   fi
}

# Comprobamos que estamos ejecutando como root el programa
if [ ! $(whoami) = "root" ]; then
   mensaje "Este script de instalacion debe ejecutarse como root. \n"
   exit 1
fi


# Iniciamos el tema de los errores.
if [ -e /tmp/errores.txt ]; then
    rm /tmp/errores.txt
fi
touch /tmp/errores.txt

#Comprobamos que estamos en el directorio adecuado
if [ ! -e ./installbulmages ]; then
 mensaje "Directorio incorrecto. La instalación debe ejecutarse desde el directorio donde se encuentra el script. \n"
 exit 1
fi


#Comprobamos que es una Debian y tiene la libreria adecuada
if [ -e /usr/lib/libqt-mt.so.3 ]; then
    export QTDIR=/usr
fi

#Comprobamos que existe la libreria de qt adecuada.
if [ ! -e ${QTDIR}/lib/libqt-mt.so.3 ]; then
        mensaje "Libreria de Qt libqt.so.3 no está instalada o no se encuentra en ${QTDIR} \n"
        exit 1
fi


# Distinguimos entre una instalación y una actualización
info "Comprobando versiones anteriores. \n" "\033[32m" "\033[0m"
tiempo

if [ -e /etc/bulmages.conf ]; then

   info "Creando el directorio /tmp/backup para guardar copias de seguridad de las bases de datos. \n"
   tiempo
   if [ -e /tmp/backup ]; then
      info -e "El directorio /tmp/backup ya existe. \n"
      linea
   else
      mkdir /tmp/backup
   fi

#  Hacemos una actualizacion de las bases de datos.
#   su - postgres -c "echo -e \"\\pset tuples_only \n select nombredb from empresa;\" | psql metabd" > /tmp/listdb.lst
#   for x in `tail +2 /tmp/listdb.lst`
#   do
#      info "Efectuando cambios sobre la base de datos $x \n Realizando copia de seguridad. \n"
#      tiempo
#      su - postgres -c "pg_dump $x" > /tmp/backup/$x.pgdump
#      for y in `ls dbmodels/actualizar/rev-*.sql | sort`
#      do
#         info "Evaluamos el archivo de revision:\n\n $y"
#         if [ ! -e /usr/share/bulmages/$y ]; then
#           su - postgres -c "psql $x "  < $y  2>> /tmp/errores.txt >> /tmp/errores.txt
#           info "Actualizando la base de datos $x con la revision version $y"
#           tiempo
#         fi
#      done
#      linea
#   done

#   info "Efectuando cambios sobre la metabase."
#   tiempo



#   for y in `ls dbmodels/actualizar/revmeta-*.sql | sort`
#   do
#      info "Evaluamos la revision $y."
#      if [ ! -e /usr/share/bulmages/$y ]; then
#         su - postgres -c "psql metabd " < $y 2>> /tmp/errores.txt >> /tmp/errores.txt
#        info "Actualizando a la version $y"
#        tiempo
#      fi
#   done
#   linea


   # También actualizarmos el fichero de backup.
   info "Realizando backup del archivo de configuracion."
   tiempo
   cp /etc/bulmages.conf bulmages.conf.old

   for j in `ls rev-bulmages*.conf | sort`
   do
      if [ ! -e /usr/share/bulmages/$j ]; then
         info "Aplicamos parche $j a bulmages.conf"
         cat $j >> /etc/bulmages.conf
      fi
   done

   # Presentamos los errores acaecidos
   cat /tmp/errores.txt | grep ERROR
else
# Se trata de una instalación nueva
        # Miramos donde está pg_hba.conf según distribuciones (habrá que discernir en más distros)

# 1 comento todas las lineas referentes al pg_hba.conf; desde ahora la configuración del postgres no se toca en la instalacion.

#        if [ -e /var/lib/postgresql/data/pg_hba.conf ]; then
#                # GENTOO lo instala aquí
#                PGDIR="/var/lib/postgresql/data"
#        elif [ -e /var/lib/pgsql/data  ]; then
#		# MANDRIVA/MANDRAKE lo instala aquí
#		PGDIR="/var/lib/pgsql/data"
#	elif [ -e /etc/postgresql/pg_hba.conf ]; then		
#                # el RESTO de DISTROS (no sé si en todas las demás será aquí)
#                PGDIR="/etc/postgresql"
#        else
#                PGDIR="0"
#                mensaje "No se encuentra el archivo de configuracion de postgresql.\n Esto puede ser debido a que no este instalado o a que no sea una distribucion con el directorio postgresql desconocido. Sin embargo continuamos con la instalacion, ya que este error puede arreglarlo a posteriori."
#                tiempo


# 2 comento todas las lineas referentes al pg_hba.conf; desde ahora la configuración del postgres no se toca en la instalacion.

        # Vamos a echar un vistacillo al pg_hba.conf
#        if [ ! $PGDIR = "0" ]; then
#               info "Revisando archivo pg_hba.conf"
#                PGA=`cat $PGDIR/pg_hba.conf | grep reject | wc -l`
#                if [ ! "$PGA" -eq "0" ]; then
#                        mensaje "Alerta: Revise el archivo $PGDIR/pg_hba.conf, ya que puede tener restricciones de permisos.\n $PGA"
#                        tiempo
#                        dialog --yesno "Si lo desea podemos instalar una copia personalizada del archivo pg_hba.conf  que configura los permisos de postgres. (Puede que con esta opcion pierda seguridad). \n" 15 60
#                        case $? in
#                          0)
#                           info "Modificando  la configuracion de postgres. \n"
#                           mv $PGDIR/pg_hba.conf $PGDIR/pg_hba.conf.old
#                           cp pg_hba.conf $PGDIR/pg_hba.conf
#                           info "Reiniciando Postgres. \n"
#                           /etc/init.d/postgresql restart >/dev/null
#                           tiempo;;
#                          1)
#                           tiempo;;
#                          255)
#                           tiempo;;
#                        esac
#                else
#                        mensaje "pg_hba es correcto"
#                fi
#        fi

# Hacemos una insercion inicial de las bases de datos.
   info "Inicializando directorio /usr/share/bulmages.\n"
   tiempo
   if [ ! -e /usr/share/bulmages ]; then
      mkdir /usr/share/bulmages
   fi

# Copiamos todos los archivos de la nueva version a sus localizaciones normales.
info "Instalando archivos de imagenes de Splash y de logotipo. \n"
tiempo
cp *.jpg /usr/share/bulmages
cp *.png /usr/share/bulmages

info "Instalando ejecutable del programa y scripts auxiliares. \n"
tiempo
cp bulmages /usr/bin
cp cargaemp /usr/bin
cp guardaemp /usr/bin
cp nuevaemp  /usr/bin
cp bulmafact /usr/bin
cp bulmacont /usr/bin
cp bulmatpv /usr/bin
cp rtkview /usr/bin
cp trml2pdf/* /usr/bin/

info "Instalando archivos de revision del archivo de configuracion. \n"
tiempo
cp rev-* /usr/share/bulmages

info "Instalando archivos de ayuda del programa, imagenes, iconos, listados y traducciones. \n"
tiempo
cp -r dbmodels /usr/share/bulmages
cp -r backgrounds /usr/share/bulmages
cp -r ayuda /usr/share/bulmages
cp -r reports /usr/share/bulmages
cp -r css /usr/share/bulmages
cp -r icons /usr/share/bulmages
cp -r traducciones /usr/share/bulmages
cp -r formularios /usr/share/bulmages
cp -r ainteligentes /usr/share/bulmages
cp -r balances /usr/share/bulmages
cp -r kugar /usr/share/bulmages
cp -r openreports /usr/share/bulmages


info "Instalando plugins iniciales. \n"
if [ ! -e /usr/lib/bulmages ]; then
        mkdir /usr/lib/bulmages
fi
cp -r plugins /usr/lib/bulmages
tiempo

info "Creando bases de datos del sistema y empresas de ejemplo. \n"
tiempo

# Creamos las bases de datos para bulmacont.
   su - postgres -c "/usr/share/bulmages/dbmodels/creabulmages $ptexto bulmages 2 Bulmages 2004"
   su - postgres -c "/usr/share/bulmages/dbmodels/creabulmages $ptexto bgplangcont 1 \"Plan Contable Vacio\" 2004"

# Creamos las bases de datos para bulmafact.
   su - postgres -c "/usr/share/bulmages/dbmodels/creabulmafact $ptexto bulmafact 1 \"Facturacion Vacia\" 2004 metabd"

   # Tratamos el archivo de configuracion
   info "Instalando la nueva version del archivo de configuracion. \n"
   cp bulmages.conf /etc

   # Presentamos los errores acaecidos
   cat /tmp/errores.txt | grep ERROR


   # Dejamos que la inserción del usuario la haga una función y asi encapsulamos un poco.
   lee
fi


info "Realizando la instalacion de BContaWeb. \n"
tiempo
if [ -e /var/www ]; then
   cp -r bcontaweb /var/www
fi

mensaje "INSTALACION FINALIZADA CON EXITO" "\033[32m" "\033[0m"

